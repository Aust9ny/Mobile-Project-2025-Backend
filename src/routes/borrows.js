import express from "express";
import { pool } from "../config/db.js";

const router = express.Router();

// ---------------------- Helper Functions ----------------------
const formatThaiDateTime = (dateString) => {
  const date = new Date(dateString);
  const thaiMonths = [
    '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
    '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
  ];
  const thaiDays = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
  
  const day = date.getDate();
  const month = thaiMonths[date.getMonth()];
  const year = date.getFullYear() + 543;
  const dayName = thaiDays[date.getDay()];
  const hours = date.getHours().toString().padStart(2, '0');
  const minutes = date.getMinutes().toString().padStart(2, '0');
  const seconds = date.getSeconds().toString().padStart(2, '0');
  
  return `‡∏ß‡∏±‡∏ô${dayName}‡∏ó‡∏µ‡πà ${day} ${month} ${year} ‡πÄ‡∏ß‡∏•‡∏≤ ${hours}:${minutes}:${seconds} ‡∏ô.`;
};

// ---------------------- User Borrows ----------------------

// ‚úÖ ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà user ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà
router.get("/user/:userId", async (req, res) => {
  const { userId } = req.params;

  if (!userId) {
    return res.status(400).json({ error: "Missing userId" });
  }

  try {
    const [borrows] = await pool.query(
      `SELECT 
        br.*,
        b.title,
        b.author,
        b.cover,
        b.genre
      FROM borrows br
      JOIN books b ON br.book_id = b.id
      WHERE br.user_id = ? AND br.status = "borrowed"
      ORDER BY br.due_date ASC`,
      [userId]
    );

    console.log(`\nüìö [User Borrows] User: ${userId} ‚Üí ${borrows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

    res.json({ borrows, totalItems: borrows.length });
  } catch (error) {
    console.error('Error fetching user borrows:', error);
    res.status(500).json({ error: 'Failed to fetch borrows' });
  }
});

// ---------------------- Book Stats ----------------------

// ‚úÖ ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡πâ‡∏ß)
router.get("/mock/:id/stats", async (req, res) => {
  const { id } = req.params;
  
  try {
    const [books] = await pool.query('SELECT * FROM books WHERE id = ?', [id]);
    
    if (books.length === 0) {
      console.log(`\n‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ID: ${id}`);
      return res.status(404).json({ error: "Book not found" });
    }

    const book = books[0];
    const borrowed = book.total - book.available;
    const available = book.available;

    const timestamp = formatThaiDateTime(new Date().toISOString());

    console.log(`\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó`);
    console.log(`‚ïë  ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠`);
    console.log(`‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£`);
    console.log(`‚ïë  ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠: "${book.title}"`);
    console.log(`‚ïë  ‡πÄ‡∏ß‡∏•‡∏≤: ${timestamp}`);
    console.log(`‚ïë  ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${book.total} ‡πÄ‡∏•‡πà‡∏° | ‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡πâ‡∏ß: ${borrowed} ‡πÄ‡∏•‡πà‡∏° | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${available} ‡πÄ‡∏•‡πà‡∏°`);
    console.log(`‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n`);

    return res.json({
      bookId: book.id,
      title: book.title,
      total: book.total,
      borrowed: borrowed,
      available: available
    });
  } catch (error) {
    console.error('Error fetching book stats:', error);
    res.status(500).json({ error: 'Failed to fetch stats' });
  }
});

// ---------------------- Borrow Book ----------------------

// ‚úÖ ‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
router.post("/mock/:id/borrow", async (req, res) => {
  const { id } = req.params;
  const { userId, action } = req.body;

  console.log(`\n‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ - User: ${userId}, Book ID: ${id}, Action: ${action}`);

  if (!userId) {
    console.log(`‡∏¢‡∏∑‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÑ‡∏°‡πà‡∏û‡∏ö userId`);
    return res.status(400).json({ error: "Missing userId" });
  }

  if (action !== "borrow") {
    return res.status(400).json({ error: "Invalid action" });
  }

  const connection = await pool.getConnection();

  try {
    await connection.beginTransaction();

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (lock row)
    const [books] = await connection.query(
      'SELECT * FROM books WHERE id = ? FOR UPDATE',
      [id]
    );

    if (books.length === 0) {
      await connection.rollback();
      console.log(`‡∏¢‡∏∑‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ID ${id}`);
      return res.status(404).json({ error: "Book not found" });
    }

    const book = books[0];

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ user ‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const [existingBorrow] = await connection.query(
      'SELECT id FROM borrows WHERE book_id = ? AND user_id = ? AND status = "borrowed"',
      [id, userId]
    );

    if (existingBorrow.length > 0) {
      await connection.rollback();
      console.log(`\n‡∏¢‡∏∑‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${userId}" ‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ "${book.title}" ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`);
      return res.status(400).json({ error: "‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß" });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (book.available <= 0) {
      await connection.rollback();
      console.log(`\n‡∏¢‡∏∑‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ "${book.title}" ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß`);
      return res.status(400).json({ error: "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏´‡∏°‡∏î" });
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î (7 ‡∏ß‡∏±‡∏ô)
    const now = new Date();
    const dueDate = new Date(now.getTime() + 7*24*60*60*1000);

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°
    await connection.query(
      'INSERT INTO borrows (book_id, user_id, borrow_date, due_date, status) VALUES (?, ?, ?, ?, "borrowed")',
      [id, userId, now, dueDate]
    );

    // ‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà available
    await connection.query(
      'UPDATE books SET available = available - 1 WHERE id = ?',
      [id]
    );

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    const [updatedBooks] = await connection.query('SELECT * FROM books WHERE id = ?', [id]);
    const updatedBook = updatedBooks[0];

    await connection.commit();

    console.log(`\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó`);
    console.log(`‚ïë  ‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    console.log(`‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£`);
    console.log(`‚ïë  ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠: "${book.title}"`);
    console.log(`‚ïë  ‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°: ${userId}`);
    console.log(`‚ïë  ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°: ${formatThaiDateTime(now.toISOString())}`);
    console.log(`‚ïë  ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatThaiDateTime(dueDate.toISOString())}`);
    console.log(`‚ïë  ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: 7 ‡∏ß‡∏±‡∏ô`);
    console.log(`‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`);

    return res.json({ 
      success: true,
      dueDate: dueDate.toISOString(),
      book: updatedBook,
      updatedStats: {
        total: updatedBook.total,
        borrowed: updatedBook.total - updatedBook.available,
        available: updatedBook.available
      }
    });
  } catch (error) {
    await connection.rollback();
    console.error('Error borrowing book:', error);
    res.status(500).json({ error: 'Failed to borrow book' });
  } finally {
    connection.release();
  }
});

// ---------------------- Return Book ----------------------

// ‚úÖ ‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
router.post("/mock/:id/return", async (req, res) => {
  const { id } = req.params;
  const { userId } = req.body;

  console.log(`\n‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ - User: ${userId}, Book ID: ${id}`);

  if (!userId) {
    console.log(`‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÑ‡∏°‡πà‡∏û‡∏ö userId`);
    return res.status(400).json({ error: "Missing userId" });
  }

  const connection = await pool.getConnection();

  try {
    await connection.beginTransaction();

    // ‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏ó‡∏µ‡πà active
    const [borrows] = await connection.query(
      'SELECT * FROM borrows WHERE book_id = ? AND user_id = ? AND status = "borrowed" FOR UPDATE',
      [id, userId]
    );

    if (borrows.length === 0) {
      await connection.rollback();
      console.log(`\n‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${userId}" ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ID ${id}`);
      return res.status(400).json({ error: "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏°‡∏ô‡∏µ‡πâ" });
    }

    const borrow = borrows[0];
    const now = new Date();
    const dueDate = new Date(borrow.due_date);
    const daysLate = Math.ceil((now.getTime() - dueDate.getTime()) / (1000*60*60*24));
    const isLate = daysLate > 0;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°
    await connection.query(
      'UPDATE borrows SET status = "returned", return_date = ? WHERE id = ?',
      [now, borrow.id]
    );

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà available
    await connection.query(
      'UPDATE books SET available = available + 1 WHERE id = ?',
      [id]
    );

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà
    const [books] = await connection.query('SELECT * FROM books WHERE id = ?', [id]);
    const book = books[0];

    await connection.commit();

    console.log(`\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó`);
    console.log(`‚ïë  ‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    console.log(`‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£`);
    console.log(`‚ïë  ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠: "${book.title}"`);
    console.log(`‚ïë  ‡∏ú‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô: ${userId}`);
    console.log(`‚ïë  ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°: ${formatThaiDateTime(borrow.borrow_date)}`);
    console.log(`‚ïë  ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatThaiDateTime(borrow.due_date)}`);
    console.log(`‚ïë  ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏à‡∏£‡∏¥‡∏á: ${formatThaiDateTime(now.toISOString())}`);
    
    if (isLate) {
      console.log(`‚ïë  ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${daysLate} ‡∏ß‡∏±‡∏ô`);
    } else {
      console.log(`‚ïë  ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Ñ‡∏∑‡∏ô‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤`);
    }
    
    console.log(`‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`);

    return res.json({ 
      success: true,
      isLate,
      daysLate: isLate ? daysLate : 0,
      book,
      updatedStats: {
        total: book.total,
        borrowed: book.total - book.available,
        available: book.available
      }
    });
  } catch (error) {
    await connection.rollback();
    console.error('Error returning book:', error);
    res.status(500).json({ error: 'Failed to return book' });
  } finally {
    connection.release();
  }
});

// ---------------------- Extend Borrow ----------------------

// ‚úÖ ‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
router.post("/mock/:id/extend", async (req, res) => {
  const { id } = req.params;
  const { userId } = req.body;

  console.log(`\n‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ - User: ${userId}, Book ID: ${id}`);

  if (!userId) {
    console.log(`‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÑ‡∏°‡πà‡∏û‡∏ö userId`);
    return res.status(400).json({ error: "Missing userId" });
  }

  const connection = await pool.getConnection();

  try {
    await connection.beginTransaction();

    // ‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏ó‡∏µ‡πà active
    const [borrows] = await connection.query(
      'SELECT * FROM borrows WHERE book_id = ? AND user_id = ? AND status = "borrowed" FOR UPDATE',
      [id, userId]
    );

    if (borrows.length === 0) {
      await connection.rollback();
      console.log(`\n‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${userId}" ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ID ${id}`);
      return res.status(400).json({ error: "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏°‡∏ô‡∏µ‡πâ" });
    }

    const borrow = borrows[0];

    if (borrow.extended) {
      await connection.rollback();
      console.log(`\n‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${userId}" ‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß`);
      return res.status(400).json({ error: "‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß" });
    }

    const now = new Date();
    const dueDate = new Date(borrow.due_date);
    const daysLeft = Math.ceil((dueDate.getTime() - now.getTime()) / (1000*60*60*24));

    if (daysLeft > 3) {
      await connection.rollback();
      console.log(`\n‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ß‡∏±‡∏ô (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysLeft} ‡∏ß‡∏±‡∏ô)`);
      return res.status(400).json({ error: "‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ß‡∏±‡∏ô" });
    }

    if (daysLeft < 0) {
      await connection.rollback();
      console.log(`\n‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß ${Math.abs(daysLeft)} ‡∏ß‡∏±‡∏ô`);
      return res.status(400).json({ error: "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏Å‡πà‡∏≠‡∏ô" });
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏¥‡πà‡∏° 7 ‡∏ß‡∏±‡∏ô)
    const newDueDate = new Date(dueDate.getTime() + 7*24*60*60*1000);

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°
    await connection.query(
      'UPDATE borrows SET due_date = ?, extended = TRUE WHERE id = ?',
      [newDueDate, borrow.id]
    );

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
    const [books] = await connection.query('SELECT * FROM books WHERE id = ?', [id]);
    const book = books[0];

    await connection.commit();

    console.log(`\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó`);
    console.log(`‚ïë  ‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    console.log(`‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£`);
    console.log(`‚ïë  ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠: "${book.title}"`);
    console.log(`‚ïë  ‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠: ${userId}`);
    console.log(`‚ïë  ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏ï‡πà‡∏≠: ${formatThaiDateTime(now.toISOString())}`);
    console.log(`‚ïë  ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏î‡∏¥‡∏°: ${formatThaiDateTime(borrow.due_date)}`);
    console.log(`‚ïë  ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏´‡∏°‡πà: ${formatThaiDateTime(newDueDate.toISOString())}`);
    console.log(`‚ïë  ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å 7 ‡∏ß‡∏±‡∏ô`);
    console.log(`‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`);

    return res.json({ 
      success: true,
      newDueDate: newDueDate.toISOString(),
      book,
      updatedStats: {
        total: book.total,
        borrowed: book.total - book.available,
        available: book.available
      }
    });
  } catch (error) {
    await connection.rollback();
    console.error('Error extending borrow:', error);
    res.status(500).json({ error: 'Failed to extend borrow' });
  } finally {
    connection.release();
  }
});

// ---------------------- Favorites (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) ----------------------

// ‚úÖ ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡∏Ç‡∏≠‡∏á user
router.get('/favorites/:userId', async (req, res) => {
  try {
    const { userId } = req.params;

    // ‡∏´‡∏≤ user_id ‡∏à‡∏≤‡∏Å temp_user_id ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏á‡πÜ
    const [favorites] = await pool.query(
      `SELECT b.* 
       FROM user_favorites uf
       JOIN books b ON uf.book_id = b.id
       WHERE uf.user_id = ?
       ORDER BY uf.created_at DESC`,
      [userId]
    );

    console.log(`\n‚ù§Ô∏è [Favorites] User: ${userId} ‚Üí ${favorites.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

    return res.json({ favorites });
  } catch (error) {
    console.error('Error fetching favorites:', error);
    return res.status(500).json({ error: 'Failed to load favorites' });
  }
});

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏à‡∏≤‡∏Å Favorites
router.post('/favorites/:userId', async (req, res) => {
  try {
    const { userId } = req.params;
    const { bookId, action } = req.body;

    if (!bookId || !action) {
      return res.status(400).json({ error: 'bookId ‡πÅ‡∏•‡∏∞ action ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ' });
    }

    if (action === 'add') {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
      const [exists] = await pool.query(
        'SELECT id FROM user_favorites WHERE user_id = ? AND book_id = ?',
        [userId, bookId]
      );

      if (exists.length > 0) {
        return res.json({ message: '‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î' });
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
      await pool.query(
        'INSERT INTO user_favorites (user_id, book_id) VALUES (?, ?)',
        [userId, bookId]
      );

      console.log(`‚ù§Ô∏è [Add Favorite] User: ${userId} ‚Üí Book: ${bookId}`);
      return res.json({ message: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
    }

    if (action === 'remove') {
      await pool.query(
        'DELETE FROM user_favorites WHERE user_id = ? AND book_id = ?',
        [userId, bookId]
      );

      console.log(`üíî [Remove Favorite] User: ${userId} ‚Üí Book: ${bookId}`);
      return res.json({ message: '‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏•‡πâ‡∏ß' });
    }

    return res.status(400).json({ error: 'action ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (add/remove ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)' });
  } catch (error) {
    console.error('Error updating favorites:', error);
    return res.status(500).json({ error: 'Failed to update favorites' });
  }
});

export default router;